# --------------------------------------------------------
# ~/.zshrc â€” unified for Fedora + macOS (Oh My Zsh + p10k)
# --------------------------------------------------------

# --- Detect OS/Arch early ---
OS=${OSTYPE}
IS_DARWIN=false
IS_LINUX=false
[[ "$OS" == darwin* ]] && IS_DARWIN=true
[[ "$OS" == linux* ]] && IS_LINUX=true

# --- Powerlevel10k instant prompt (must stay at the very top) ---
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# --- XDG base dirs ---
: "${XDG_CONFIG_HOME:=$HOME/.config}"
: "${XDG_CACHE_HOME:=$HOME/.cache}"
: "${XDG_STATE_HOME:=$HOME/.local/state}"

# --- Oh My Zsh base path ---
export ZSH="$HOME/.oh-my-zsh"

# --- Completions path BEFORE OMZ loads ---
fpath+=(${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-completions/src)

# --- Fast, quiet completion cache ---
export ZSH_COMPDUMP="${XDG_CACHE_HOME}/zsh/.zcompdump-$ZSH_VERSION"
mkdir -p "${ZSH_COMPDUMP:h}"
ZSH_DISABLE_COMPFIX="true"

# --- Theme ---
ZSH_THEME="powerlevel10k/powerlevel10k"

# --- Plugins (lean for speed) ---
# Note: 'fzf' and 'zoxide' handled manually below for performance
plugins=(
  git
  zsh-autosuggestions
  fast-syntax-highlighting
)

# --- Load Oh My Zsh ---
[[ -r "$ZSH/oh-my-zsh.sh" ]] && source "$ZSH/oh-my-zsh.sh"

# -------------------- QoL & Visuals --------------------

# History
HISTSIZE=50000
SAVEHIST=50000
HISTFILE="${XDG_STATE_HOME}/zsh/history"
mkdir -p "${HISTFILE:h}"
setopt APPEND_HISTORY INC_APPEND_HISTORY SHARE_HISTORY
setopt HIST_IGNORE_DUPS HIST_IGNORE_ALL_DUPS HIST_REDUCE_BLANKS HIST_VERIFY
setopt EXTENDED_HISTORY

# Shell behaviour
setopt INTERACTIVE_COMMENTS
setopt AUTO_CD
setopt NO_FLOW_CONTROL
setopt COMPLETE_IN_WORD

# Completion styles
zmodload zsh/complist
zstyle ':completion:*' completer _complete _correct _approximate
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'

# Colored Man Pages
export LESS_TERMCAP_mb=$'\E[01;31m'      # Begin blinking
export LESS_TERMCAP_md=$'\E[01;31m'      # Begin bold
export LESS_TERMCAP_me=$'\E[0m'          # End mode
export LESS_TERMCAP_se=$'\E[0m'          # End standout-mode
export LESS_TERMCAP_so=$'\E[01;44;33m'   # Begin standout-mode - info box
export LESS_TERMCAP_ue=$'\E[0m'          # End underline
export LESS_TERMCAP_us=$'\E[01;32m'      # Begin underline

# -------------------- PATH hygiene --------------------
export PATH="$HOME/.local/bin:$HOME/bin:$PATH"

# macOS: Homebrew (Optimized: No slow 'brew --prefix' subshell)
if $IS_DARWIN; then
  if [[ -d "/opt/homebrew/bin" ]]; then
    export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:$PATH"
    BREW_PREFIX="/opt/homebrew"
  elif [[ -d "/usr/local/bin" ]]; then
    export PATH="/usr/local/bin:/usr/local/sbin:$PATH"
    BREW_PREFIX="/usr/local"
  fi
  # GNU Coreutils
  if [[ -n "$BREW_PREFIX" && -d "$BREW_PREFIX/opt/coreutils/libexec/gnubin" ]]; then
    export PATH="$BREW_PREFIX/opt/coreutils/libexec/gnubin:$PATH"
  fi
fi

# -------------------- Navigation & Tools --------------------

# 1. Zoxide (Smarter 'cd')
if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init zsh)"
  alias cd='z'
fi

# 2. FZF Integration
if $IS_LINUX; then
  [[ -f /usr/share/fzf/shell/key-bindings.zsh ]] && source /usr/share/fzf/shell/key-bindings.zsh
  [[ -f /usr/share/fzf/shell/completion.zsh    ]] && source /usr/share/fzf/shell/completion.zsh
elif $IS_DARWIN && [[ -n "$BREW_PREFIX" ]]; then
  FZF_DIR="$BREW_PREFIX/opt/fzf/shell"
  [[ -f "$FZF_DIR/key-bindings.zsh" ]] && source "$FZF_DIR/key-bindings.zsh"
  [[ -f "$FZF_DIR/completion.zsh"    ]] && source "$FZF_DIR/completion.zsh"
fi

# -------------------- Language/toolchain shims --------------------

# pyenv
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
if command -v pyenv >/dev/null 2>&1; then
  eval "$(pyenv init - zsh)"
  eval "$(pyenv virtualenv-init -)"
fi

# TeX Live / MacTeX (Dynamic Versioning)
if $IS_LINUX; then
  local tex_dirs=(/usr/local/texlive/*(N/On))
  if (( ${#tex_dirs} > 0 )); then
    export PATH="${tex_dirs[1]}/bin/x86_64-linux:$PATH"
    export MANPATH="${tex_dirs[1]}/texmf-dist/doc/man:${MANPATH:-}"
    export INFOPATH="${tex_dirs[1]}/texmf-dist/doc/info:${INFOPATH:-}"
  fi
elif $IS_DARWIN; then
  export PATH="/Library/TeX/texbin:$PATH"
fi

# -------------------- Aliases & Functions --------------------

# Safety Nets
alias cp='cp -i'
alias mv='mv -i'
alias rm='rm -I' # Prompts if deleting >3 files

# Modern CLI Replacements (if installed)
command -v bat >/dev/null 2>&1 && alias cat='bat'
command -v rg  >/dev/null 2>&1 && alias grep='rg'

# List files
alias ls='lsd --icon auto'
alias ll='lsd -lh --git --icon auto'
alias la='lsd -la --git --icon auto'
alias lt='lsd --tree --depth=2 --icon auto'

# Git shortcuts
alias gs='git status'
alias gc='git commit -v'
alias gp='git push'

# Global Aliases (Use anywhere in the line)
alias -g G='| grep'
alias -g L='| less'
alias -g ...='../..'

# Smart Copy Alias (Mac vs Linux)
if $IS_DARWIN; then
  alias -g C='| pbcopy'
elif $IS_LINUX; then
  if command -v wl-copy >/dev/null; then
    alias -g C='| wl-copy' # Wayland
  elif command -v xclip >/dev/null; then
    alias -g C='| xclip -selection clipboard' # X11
  fi
fi

# Navigation Shortcuts
alias Workspace='cd $HOME/workspace/ && la'
alias Projects='cd $HOME/workspace/projects/ && la'
alias Thirdway='cd $HOME/workspace/projects/thirdway/ && la'
alias Koralis='cd $HOME/workspace/projects/koralis-ai && la'
alias Kairos='cd $HOME/workspace/projects/kairos-flow && la'

# Utility Functions
function mkcd() { mkdir -p "$@" && cd "$_"; }

# -------------------- Prompt/theme config --------------------
[[ -r "$HOME/.p10k.zsh" ]] && source "$HOME/.p10k.zsh"

# 1Password SSH Agent
export SSH_AUTH_SOCK="$HOME/.1password/agent.sock"

# chezmoi aliases
alias cz='chezmoi'
alias czp='dot-push'

# -------------------- smart sync helpers --------------------

function dot-push() {
  echo "ğŸ§­ Adding and pushing chezmoi changes..."
  local -a files=(~/.zshrc ~/.p10k.zsh ~/.config/starship.toml)
  local f
  for f in "${files[@]}"; do
    [[ -e "$f" ]] && chezmoi add "$f"
  done
  (
    cd "$(chezmoi source-path)" || { echo "âŒ Could not enter chezmoi source dir."; exit 1; }
    if git diff --quiet && git diff --cached --quiet; then
      echo "â„¹ï¸  No changes to commit."
      exit 0
    fi
    git add -A
    git commit -m "${1:-update dotfiles}"
    git push -u origin HEAD
  ) && echo "âœ… Dotfiles pushed."
}

function dot-pull() {
  echo "â¬‡ï¸  Updating chezmoi from GitHub..."
  (
    cd "$(chezmoi source-path)" || return 1
    current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "unknown")
    echo "ğŸ“¦ Current branch: $current_branch"
  )
  if chezmoi update -v; then
    echo "âœ… Dotfiles updated and applied."
  else
    echo "âŒ ChezMoi update failed."
    return 1
  fi
}



